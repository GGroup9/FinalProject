---
title: "Final Project"
author: "Zhaojin Zhu, Zhijia Ju, Yifei Wang, Zhiyi Xie"
date: "2020/11/29"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Abstract


This project discusses the factors influencing life expectancy, health factors for 193 countries based on the dataset provided by the Global Health Observatory(GHO) data repository under World Health Organization(WHO). In this project we consider data from 2000 to 2015 for 193 countries which focus on immunization factors, mortality factors, economic factors, social factors and other health related factors as well for further analysis. 
There are 22 columns and 2930 rows in the dataset file `Life Expectancy Data.csv`.

## Introduction

Nowadays the living standards have improved significantly in many ways. Factors including economy, education and medical condition all have developed to a new stage after the Millennium. Previous researches did not include immunization factor and human development index when analyzing factors affecting life expectancy.That brought to our attention are immunization and human development index significant in influencing life expectancy. And, what other factors would actually affect life expectancy that were not included in the past studies. If immunization factor turns out to be significant in influencing life expectancy, could lifespan be improved if government spend more expenditure on healthcare? Furthermore, would personal habits and lifestyle have relationship with life expectancy? Would economical factor have an effect on life expectancy, that is, do developing countries have lower life expectancy than developed countries? What are the potential causes for a country to have a low life expectancy?


( These are the factors that may have impact on our life expectancy. However, which one of the factors are the most significant or which factors only has a small impact that can be ignored? Moreover, the developed and developing countries have different living standards and social phenomenon. Is the developing country has less life expectancy than developed country or vice versa? What are the reasons for the countries that have a lower life expectancy?

We are describing the dataset by using data visualization, evaluating and fit different regression model to analyze the various factors that has impact on the life expectancy. )

## Data Description

Our dataset consists of 22 Columns and 2938 rows, including 20 predictors that are divided into 4 broad categories: Immunization related factors, Mortality factors, Economical factors and Social factors.

Immunization related factors contains Hepatitis B (HepB immunization coverage among 1-year-old), Measles (number of reported cases per 1000 population), Polio (Pol3 immunization coverage among 1-year-old), Diphtheria (Diphtheria tetanus toxoid and pertussis, DTP3, immunization coverage among 1-year-old), HIV AIDS (Deaths per 1000 live births HIV/AIDS from 0 to 4 years old).

Mortality factors contains Adult Mortality (Adult Mortality Rates of both sexes), Infant Deaths (Number of Infant Deaths per 1000 population), Under Five Deaths (Number of under-five deaths per 1000 population).

Economical factors contains Country, Status (developing or developed), Percentage Expenditure (Expenditure on health as a percentage of Gross Domestic Product per capita), Total Expenditure (General government expenditure on health as a percentage of total government expenditure), GDP (Gross Domestic Product per capita), Population (Population of the country), Income Composition of Resources (Human Development Index in terms of income composition of resources).

Social factors contains Year (the year of the data), Alcohol (recorded per capita (15+) consumption), BMI (Average Body Mass Index of entire population), Thinness 1-19 Years (Prevalence of thinness among children and adolescents for Age 10 to 19), Thinness 5-9 Years (Prevalence of thinness among children for Age 5 to 9), Schooling (Number of years of Schooling).

If we consider the Country predictor as a detailed subset of the Status predictor, we could remove the Country predictor and only focus on the developing and developed status for constructing a general idea regardless of a specific country. However, if we want to know the life expectancy of a specific country, we could include the specific country value from the Country predictor.


```{r}
library(tidyverse)
library(car)
who <- read.csv(file = "Life Expectancy Data.csv", header=TRUE)
#Looking at the  data
head(who)
attach(who)
#remove Country since we are not focusing on specific countries in this research
who <- who[,-c(1)]

# exclude missing values (Remove Rows with Missing Data)
who = who[complete.cases(who),]
# 1289 observations were deleted

#fit regression model
model <- lm(Life.expectancy~., data = who)
summary(model)
avPlots(model)

#check pairwise correlations
cor(who[,-c(1,2)])

```
From the added variable plots, we can see that predictors like infant.deaths, percentage.expenditure, Measles, under.five.deaths, GDP, Population, thinness..1.19.years and thinness.5.9.years seem to have no significant linear relationship with life expectancy.
From the pairwise correlation data, there are several variables collinear with each other (they have correlation close to 1). These highly collinearly related variable pairs are under.five.deaths and infant.deaths, GDP and percentage.expenditure, thinness.5.9.years and thinness..1.19.years.



```{r}
#Residual Analysis
plot(model)

#Standardized Residuals vs. Index tut 4
plot( rstandard(model))

n <- nrow( who )
plot( model$residuals[1:(n-1)] , model$residuals[2:n])

model_influence <- influence(model)
sort(model_influence$hat, decreasing = TRUE)

model_cook <- cooks.distance(model)
sort(model_cook, decreasing = TRUE)

#Stepwise Regression using AIC
step(model, direction = 'both')
# we get a final model that has 14 out of the 20 possible predictors.
```








## Method

To test if each predictor has linear relationship with life expectancy, we use t-test to investigate.
H0: beta_j = 0
H1: beta_j != 0
test statistics: t0
We reject H0 if p value > alpha=0.05. 

summary(model)

From the OLS summary table, we see that the p-values for percentage.expenditure, Hepatitis.B, Measles, Polio, GDP, Population, thinness 1-19 years and thinness 5-9 years are higher than alpha=0.05, 
which means further investigation is needed to determine whether these predictors are significant or not in predicting the life expectancy.

(1289 observations were deleted due to missingness.

From the OLS summary table, we see that the p-values for predictors like percentage.expenditure, Hepatitis.B, Measles, Polio, GDP, Population, thinness 1-19 years and thinness 5-9 years are high than alpha=0.05, which mean further investigation is
needed to determine whether these predictors are significant or not in predicting the life expectancy.

Checked the diagonal of the hat matrix, only two observations have leverages higher than 0.2 , that may have the potential to be influential. However, given the large dataset, the rest of the observations have small leverages. Since none of these countries had large residuals, so we need to investigate a little more.

For our data and model, no observation has cook's distance larger than 1.
From stepwise regression, we get a final model that has 14 out of the 20 possible predictors.

The figure sizes have been customized so that you can easily put two images side-by-side. )

```{r, fig.show='hold'}
#checked the  model
summodel <-  summary(model)
#percentage.expenditure and Hepatitis.B and Measle and Polio and GDP and Population 
#thinness..1.19.years  and thinness.5.9.years larger than 0.05

#Life.expectancy and GDP
gdp <- lm( Life.expectancy ~ GDP , data = who )
summary(gdp)


## standardize data using unit length scaling ##

#unit length scalings
s_Year<-sqrt(sum((who$Year-mean(who$Year))^2))
#s_Status<-sqrt(sum((Status-mean(Status))^2))
s_Adult.Mortality = sqrt(sum((who$Adult.Mortality-mean(who$Adult.Mortality))^2))
s_infant.deaths<-sqrt(sum((who$infant.deaths-mean(who$infant.deaths))^2))
s_Alcohol<-sqrt(sum((who$Alcohol-mean(who$Alcohol))^2))
s_percentage.expenditure<-sqrt(sum((who$percentage.expenditure-mean(who$percentage.expenditure))^2))
s_Hepatitis.B<-sqrt(sum((who$Hepatitis.B-mean(who$Hepatitis.B))^2))
s_Measles<-sqrt(sum((who$Measles-mean(who$Measles))^2))
s_BMI<-sqrt(sum((who$BMI-mean(who$BMI))^2))
s_under.five.deaths<-sqrt(sum((who$under.five.deaths-mean(who$under.five.deaths))^2))
s_Life.expectancy = sqrt(sum((who$Life.expectancy-mean(who$Life.expectancy))^2))

s12  = sqrt(sum((who$Polio - mean(who$Polio))^2))
s13  = sqrt(sum((who$Total.expenditure - mean(who$Total.expenditure))^2))
s14  = sqrt(sum((who$Diphtheria - mean(who$Diphtheria))^2))
s15  = sqrt(sum((who$HIV.AIDS - mean(who$HIV.AIDS))^2))
s16  = sqrt(sum((who$GDP - mean(who$GDP))^2))
s17  = sqrt(sum((who$Population - mean(who$Population))^2))
s18  = sqrt(sum((who$thinness..1.19.years - mean(who$thinness..1.19.years))^2))
s19  = sqrt(sum((who$thinness.5.9.years - mean(who$thinness.5.9.years))^2))
s20  = sqrt(sum((who$Income.composition.of.resources -mean(who$Income.composition.of.resources))^2))
s21  = sqrt(sum((who$Schooling - mean(who$Schooling))^2))

z_Year<-(who$Year-mean(who$Year))/s_Year
#z_Status<-(Status-mean(Status))/s_Status
z_Adult.Mortality<-(who$Adult.Mortality-mean(who$Adult.Mortality))/s_Adult.Mortality
z_infant.deaths<-(who$infant.deaths-mean(who$infant.deaths))/s_infant.deaths
z_Alcohol<-(who$Alcohol-mean(who$Alcohol))/s_Alcohol
z_percentage.expenditure<-(who$percentage.expenditure-mean(who$percentage.expenditure))/s_percentage.expenditure
z_Hepatitis.B<-(who$Hepatitis.B-mean(who$Hepatitis.B))/s_Hepatitis.B
z_Measles<-(who$Measles-mean(who$Measles))/s_Measles
z_BMI<-(who$BMI-mean(who$BMI))/s_BMI
z_under.five.deaths<-(who$under.five.deaths-mean(who$under.five.deaths))/s_under.five.deaths
Life.expectancy_s<-(who$Life.expectancy-mean(who$Life.expectancy))/s_Life.expectancy

z12 = (who$Polio - mean(who$Polio))/s12
z13 = (who$Total.expenditure - mean(who$Total.expenditure))/s13
z14 = (who$Diphtheria - mean(who$Diphtheria))/s14
z15 = (who$HIV.AIDS - mean(who$HIV.AIDS))/s15
z16 = (who$GDP - mean(who$GDP))/s16
z17 = (who$Population - mean(who$Population))/s17
z18 = (who$thinness..1.19.years - mean(who$thinness..1.19.years))/s18
z19 = (who$thinness.5.9.years - mean(who$thinness.5.9.years))/s19
z20 = (who$Income.composition.of.resources - mean(who$Income.composition.of.resources))/s20
z21 = (who$Schooling - mean(who$Schooling))/s21

LifeSRModel<-lm(Life.expectancy_s~z_Year+z_Adult.Mortality+z_infant.deaths+z_Alcohol+z_percentage.expenditure+z_Hepatitis.B+z_Measles+z_BMI+z_under.five.deaths + z12 + z13 + z14 + z15 + z16 + z17 + z18 + z19 + z20 + z21 - 1  )


## variable selection ##

summary(LifeSRModel)
LifeSRModel$coefficients
#Coefficients:
#                          Estimate Std. Error t value Pr(>|t|)    
#z_Year                   -0.060350   0.010731  -5.624 2.20e-08 ***
#z_Adult.Mortality        -0.234136   0.013414 -17.455  < 2e-16 ***
#z_infant.deaths           1.220016   0.145757   8.370  < 2e-16 ***
#z_Alcohol                -0.045031   0.014339  -3.140  0.00172 ** 
#z_percentage.expenditure  0.062125   0.035825   1.734  0.08309 .  
#z_Hepatitis.B            -0.006774   0.012928  -0.524  0.60037    
#z_Measles                -0.012693   0.012282  -1.033  0.30153    
#z_BMI                     0.070855   0.013391   5.291 1.38e-07 ***
#z_under.five.deaths      -1.234195   0.142298  -8.673  < 2e-16 ***
#z12                       0.014449   0.013088   1.104  0.26978    
#z13                       0.025121   0.010575   2.375  0.01764 *  
#z14                       0.033220   0.014432   2.302  0.02147 *  
#z15                      -0.308248   0.012218 -25.229  < 2e-16 ***
#z16                       0.038486   0.036845   1.045  0.29639    
#z17                      -0.005228   0.013903  -0.376  0.70694    
#z18                      -0.001193   0.027504  -0.043  0.96541    
#z19                      -0.028094   0.027466  -1.023  0.30653    
#z20                       0.217914   0.017357  12.555  < 2e-16 ***
#z21                       0.287996   0.018759  15.353  < 2e-16 ***
#Residual standard error: 0.009973 on 1630 degrees of freedom
#Multiple R-squared:  0.8379,	Adjusted R-squared:  0.836 
#F-statistic: 443.4 on 19 and 1630 DF,  p-value: < 2.2e-16


##hypothesis test
#F test 
#2.2e-16 < 0.05, reject H0, at least 1 predictor is useful. 

#t test
#for the predictors with p value > 0.05, we investigate them independently. 

#Life.expectancy_s and percentage.expenditure
le <- lm( Life.expectancy_s ~ z_percentage.expenditure )
summary(le)
# Estimate Std. Error t value Pr(>|t|)    
#(Intercept)              1.794e-17  5.536e-04    0.00        1    
#z_percentage.expenditure 4.096e-01  2.248e-02   18.22   <2e-16 ***

#Life.expectancy_s and Hepatitis.B
lh <- lm( Life.expectancy_s ~ z_Hepatitis.B )
summary(lh)
# Estimate Std. Error t value Pr(>|t|)    
#(Intercept)   1.608e-17  5.945e-04   0.000        1    
#z_Hepatitis.B 1.999e-01  2.414e-02   8.281 2.49e-16 ***

#Life.expectancy_s and Measles
lmea <- lm( Life.expectancy_s ~ z_Measles )
summary(lmea)
#Estimate Std. Error t value Pr(>|t|)   
#(Intercept)  1.804e-17  6.054e-04   0.000  1.00000   
#z_Measles   -6.888e-02  2.458e-02  -2.802  0.00514 **

#Life.expectancy_s and Polio
lp <- lm( Life.expectancy_s ~ z12 )
summary(lp)
#Estimate Std. Error t value Pr(>|t|)    
#(Intercept) 1.998e-17  5.734e-04    0.00        1    
#z12         3.273e-01  2.328e-02   14.06   <2e-16 ***

#Life.expectancy_s and GDP
lg <- lm( Life.expectancy_s ~ z16 )
summary(lg)
#Estimate Std. Error t value Pr(>|t|)    
#(Intercept) 1.788e-17  5.445e-04    0.00        1    
#z16         4.413e-01  2.211e-02   19.96   <2e-16 ***

#Life.expectancy_s and Population
lpo <- lm( Life.expectancy_s ~ z17)
summary(lpo)
# Estimate Std. Error t value Pr(>|t|)
#(Intercept)  1.787e-17  6.066e-04   0.000    1.000
#z17         -2.230e-02  2.463e-02  -0.905    0.365

#Life.expectancy_s and thinness..1.19.years
lt1 <- lm( Life.expectancy_s ~ z18 )
summary(lt1)
# Estimate Std. Error t value Pr(>|t|)    
#(Intercept)  2.020e-17  5.395e-04     0.0        1    
#z18         -4.578e-01  2.191e-02   -20.9   <2e-16 ***

#Life.expectancy_s and thinness.5.9.years
lt5 <- lm( Life.expectancy_s ~ z19 )
summary(lt5)
# Estimate Std. Error t value Pr(>|t|)    
#(Intercept)  1.817e-17  5.396e-04    0.00        1    
#z19         -4.575e-01  2.191e-02  -20.88   <2e-16 ***


#only population has p value > 0.05 when fitting simple linear regression line with life expectancy,
#so coefficient of population is close to 0. Thus population is not strongly linearly related with life expectancy. We can remove population from the model then. 

#population remove from dataset 'who'
#with standardized data
LifeSRModel<-lm(Life.expectancy_s~z_Year+z_Adult.Mortality+z_infant.deaths+z_Alcohol+z_percentage.expenditure+z_Hepatitis.B+z_Measles+z_BMI+z_under.five.deaths + z12 + z13 + z14 + z15 + z16 + z18 + z19 + z20 + z21 - 1  )
summary(LifeSRModel)

#with original data
modelO <- lm(Life.expectancy~Year+Status+Adult.Mortality+infant.deaths+Alcohol+percentage.expenditure+Hepatitis.B+Measles+BMI+under.five.deaths + Polio + Total.expenditure + Diphtheria + HIV.AIDS + GDP + thinness..1.19.years + thinness.5.9.years + Income.composition.of.resources + Schooling, data = who)
summary(modelO)


##stepwize
#use stepwize method to complete variable selection
step(model, direction = 'both')

model = lm(formula = Life.expectancy ~ Year + Status + Adult.Mortality + 
    infant.deaths + Alcohol + percentage.expenditure + BMI + 
    under.five.deaths + Total.expenditure + Diphtheria + HIV.AIDS + 
    thinness.5.9.years + Income.composition.of.resources + Schooling, 
    data = who)

summary(model)



## residual analysis ##
plot(model)
#constant variance (if not good, use transformation of y)

#linearity (if not good, transformation of x)

#outlier
#leverage(cooks)
#influence

#There is potential outlier, so we use robust
#robust
Rmodel = rlm(formula = Life.expectancy ~ Year + Status + Adult.Mortality + 
    infant.deaths + Alcohol + percentage.expenditure + BMI + 
    under.five.deaths + Total.expenditure + Diphtheria + HIV.AIDS + 
    thinness.5.9.years + Income.composition.of.resources + Schooling, 
    data = who, psi = psi.huber)

summary(Rmodel)
#Coefficients:
#                                Value    Std. Error t value 
#(Intercept)                     272.5698  41.5919     6.5534
#Year                             -0.1086   0.0208    -5.2278
#StatusDeveloping                 -0.5367   0.3050    -1.7598
#Adult.Mortality                  -0.0194   0.0009   -22.4861
#infant.deaths                     0.0821   0.0091     9.0416
#Alcohol                          -0.0996   0.0307    -3.2450
#percentage.expenditure            0.0004   0.0001     7.5188
#BMI                               0.0280   0.0054     5.1863
#under.five.deaths                -0.0624   0.0067    -9.2397
#Total.expenditure                 0.1123   0.0369     3.0432
#Diphtheria                        0.0142   0.0041     3.4524
#HIV.AIDS                         -0.4202   0.0163   -25.8149
#thinness.5.9.years               -0.0562   0.0240    -2.3429
#Income.composition.of.resources  10.7256   0.7597    14.1178
#Schooling                         0.8434   0.0535    15.7651

#percentage changed comparing with lm
#0.14, 0.40, 

##Bootstrap


## model validation ##
#cross validation

## confidence interval ##

## prediction interval ##



## predict a new point



plot(1:10)
plot(10:1)
```


##Conclusion











You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## Results

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))

## Conclusion