---
title: "Final Project"
author: "Zhaojin Zhu, Zhijia Ju, Yifei Wang, Zhiyi Xie"
date: "2020/11/29"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Abstract


This project discusses the factors influencing life expectancy, health factors for 193 countries based on the dataset provided by the Global Health Observatory(GHO) data repository under World Health Organization(WHO). In this project we consider data from 2000 to 2015 for 193 countries which focus on immunization factors, mortality factors, economic factors, social factors and other health related factors as well for further analysis. 
There are 22 columns and 2930 rows in the dataset file `Life Expectancy Data.csv`.

## Introduction

Nowadays the living standards have improved significantly in many ways. Factors including economy, education and medical condition all have developed to a new stage after the Millennium. Previous researches did not include immunization factor and human development index when analyzing factors affecting life expectancy.That brought to our attention are immunization and human development index significant in influencing life expectancy. And, what other factors would actually affect life expectancy that were not included in the past studies. If immunization factor turns out to be significant in influencing life expectancy, could lifespan be improved if government spend more expenditure on healthcare? Furthermore, would personal habits and lifestyle have relationship with life expectancy? Would economical factor have an effect on life expectancy, that is, do developing countries have lower life expectancy than developed countries? What are the potential causes for a country to have a low life expectancy?


( These are the factors that may have impact on our life expectancy. However, which one of the factors are the most significant or which factors only has a small impact that can be ignored? Moreover, the developed and developing countries have different living standards and social phenomenon. Is the developing country has less life expectancy than developed country or vice versa? What are the reasons for the countries that have a lower life expectancy?

We are describing the dataset by using data visualization, evaluating and fit different regression model to analyze the various factors that has impact on the life expectancy. )

## Data Description

Our dataset consists of 22 Columns and 2938 rows, including 20 predictors that are divided into 4 broad categories: Immunization related factors, Mortality factors, Economical factors and Social factors.

Immunization related factors contains Hepatitis B (HepB immunization coverage among 1-year-old), Measles (number of reported cases per 1000 population), Polio (Pol3 immunization coverage among 1-year-old), Diphtheria (Diphtheria tetanus toxoid and pertussis, DTP3, immunization coverage among 1-year-old), HIV AIDS (Deaths per 1000 live births HIV/AIDS from 0 to 4 years old).

Mortality factors contains Adult Mortality (Adult Mortality Rates of both sexes), Infant Deaths (Number of Infant Deaths per 1000 population), Under Five Deaths (Number of under-five deaths per 1000 population).

Economical factors contains Country, Status (developing or developed), Percentage Expenditure (Expenditure on health as a percentage of Gross Domestic Product per capita), Total Expenditure (General government expenditure on health as a percentage of total government expenditure), GDP (Gross Domestic Product per capita), Population (Population of the country), Income Composition of Resources (Human Development Index in terms of income composition of resources).

Social factors contains Year (the year of the data), Alcohol (recorded per capita (15+) consumption), BMI (Average Body Mass Index of entire population), Thinness 1-19 Years (Prevalence of thinness among children and adolescents for Age 10 to 19), Thinness 5-9 Years (Prevalence of thinness among children for Age 5 to 9), Schooling (Number of years of Schooling).

If we consider the Country predictor as a detailed subset of the Status predictor, we could remove the Country predictor and only focus on the developing and developed status for constructing a general idea regardless of a specific country. However, if we want to know the life expectancy of a specific country, we could include the specific country value from the Country predictor.

We would like to introduce one new additional data point into our dataset. The values for this unique data point is as follows. Country:China, Year:2015, Status:Developing, Life expectancy:74.2625, Adult Mortality:73.75, infant deaths: 294.875, Alcohol:4.182, percentage.expenditure: 78.48934709, Hepatitis.B: 80.4375, Measles: 65857.9375, BMI: 21.80625, under.five.deaths: 350, Polio: 93.6875, Total.expenditure: 4.918, Diphtheria: 93.3125, HIV.AIDS: 0.1, GDP: 2345.303158,
Population: 321812.0625, thinness..1.19.years: 4.6375, thinness.5.9.years: 4.025, Income.composition.of.resources: 0.66025, Schooling: 11.4375. These values are calculated based on the average values for each predictor from 2000 to 2015 for the country of China. Our modified dataset now consists of 22 Columns and 2939 rows.




```{r}
library(tidyverse)
library(car)
library(MASS)
who <- read.csv(file = "Life Expectancy Data.csv", header=TRUE)
#Looking at the  data
head(who)
attach(who)


# introduce one new additional data point into our dataset
china_new_data_point = data.frame("China", 2015, "Developing", 74.2625,73.75,	294.875	,4.182,	78.48934709	,80.4375,	65857.9375,	21.80625,	350	,93.6875,	4.918,	93.3125,	0.1,	2345.303158,	321812.0625,	4.6375,	4.025	,0.66025,	11.4375)

names(china_new_data_point) = c("Country","Year","Status","Life.expectancy","Adult.Mortality","infant.deaths","Alcohol","percentage.expenditure","Hepatitis.B","Measles" , "BMI" ,"under.five.deaths" ,"Polio","Total.expenditure","Diphtheria" , "HIV.AIDS","GDP","Population", "thinness..1.19.years", "thinness.5.9.years","Income.composition.of.resources","Schooling")

who = rbind(china_new_data_point,who)

#remove Country since we are not focusing on specific countries in this research
who <- who[,-c(1)]


# exclude missing values (Remove Rows with Missing Data)
who = who[complete.cases(who),]
# 1289 observations were deleted
# 1650 observations remaining

#fit regression model
model <- lm(Life.expectancy~., data = who)
summary(model)
avPlots(model)

#check pairwise correlations
cor(who[,-c(1,2)])

```
From the added variable plots, we can see that predictors like infant.deaths, percentage.expenditure, Measles, under.five.deaths, GDP, Population, thinness..1.19.years and thinness.5.9.years seem to have no significant linear relationship with life expectancy.
From the pairwise correlation data, there are several variables collinear with each other (they have correlation close to 1). These highly collinearly related variable pairs are under.five.deaths and infant.deaths, GDP and percentage.expenditure, thinness.5.9.years and thinness..1.19.years.



```{r}
#Residual Analysis
plot(model)

#Standardized Residuals vs. Index tut 4
plot( rstandard(model))

n <- nrow( who )
plot( model$residuals[1:(n-1)] , model$residuals[2:n])

model_influence <- influence(model)
sort(model_influence$hat, decreasing = TRUE)

model_cook <- cooks.distance(model)
sort(model_cook, decreasing = TRUE)

#Stepwise Regression using AIC
step(model, direction = 'both')
# we get a final model that has 14 out of the 20 possible predictors.
```








## Method

To test if each predictor has linear relationship with life expectancy, we use t-test to investigate.
H0: beta_j = 0
H1: beta_j != 0
test statistics: t0
We reject H0 if p value > alpha=0.05. 

summary(model)

From the OLS summary table, we see that the p-values for percentage.expenditure, Hepatitis.B, Measles, Polio, GDP, Population, thinness 1-19 years and thinness 5-9 years are higher than alpha=0.05, 
which means further investigation is needed to determine whether these predictors are significant or not in predicting the life expectancy.

(1289 observations were deleted due to missingness.

From the OLS summary table, we see that the p-values for predictors like percentage.expenditure, Hepatitis.B, Measles, Polio, GDP, Population, thinness 1-19 years and thinness 5-9 years are high than alpha=0.05, which mean further investigation is
needed to determine whether these predictors are significant or not in predicting the life expectancy.

Checked the diagonal of the hat matrix, only two observations have leverages higher than 0.2 , that may have the potential to be influential. However, given the large dataset, the rest of the observations have small leverages. Since none of these countries had large residuals, so we need to investigate a little more.

For our data and model, no observation has cook's distance larger than 1.
From stepwise regression, we get a final model that has 14 out of the 20 possible predictors.

The figure sizes have been customized so that you can easily put two images side-by-side. )

```{r, fig.show='hold'}
#checked the  model
summodel <-  summary(model)
#percentage.expenditure and Hepatitis.B and Measle and Polio and GDP and Population 
#thinness..1.19.years  and thinness.5.9.years larger than 0.05
```


Due to different scaling in the dataset 'who' , it is difficult to compare regression coefficients because the magnitude of betaj reflects the units of measurement of the regressor xj.
For this reason it is helpful to work with scaled regressor and response variable.
Here we will use Unit Length Scaling:
```{r}
#Life.expectancy and GDP
gdp <- lm( Life.expectancy ~ GDP , data = who )
summary(gdp)

## standardize data using unit length scaling ##
#unit length scalings
s_Year<-sqrt(sum((who$Year-mean(who$Year))^2))
#s_Status<-sqrt(sum((Status-mean(Status))^2))
s_Adult.Mortality = sqrt(sum((who$Adult.Mortality-mean(who$Adult.Mortality))^2))
s_infant.deaths<-sqrt(sum((who$infant.deaths-mean(who$infant.deaths))^2))
s_Alcohol<-sqrt(sum((who$Alcohol-mean(who$Alcohol))^2))
s_percentage.expenditure<-sqrt(sum((who$percentage.expenditure-mean(who$percentage.expenditure))^2))
s_Hepatitis.B<-sqrt(sum((who$Hepatitis.B-mean(who$Hepatitis.B))^2))
s_Measles<-sqrt(sum((who$Measles-mean(who$Measles))^2))
s_BMI<-sqrt(sum((who$BMI-mean(who$BMI))^2))
s_under.five.deaths<-sqrt(sum((who$under.five.deaths-mean(who$under.five.deaths))^2))
s_Life.expectancy = sqrt(sum((who$Life.expectancy-mean(who$Life.expectancy))^2))

s12  = sqrt(sum((who$Polio - mean(who$Polio))^2))
s13  = sqrt(sum((who$Total.expenditure - mean(who$Total.expenditure))^2))
s14  = sqrt(sum((who$Diphtheria - mean(who$Diphtheria))^2))
s15  = sqrt(sum((who$HIV.AIDS - mean(who$HIV.AIDS))^2))
s16  = sqrt(sum((who$GDP - mean(who$GDP))^2))
s17  = sqrt(sum((who$Population - mean(who$Population))^2))
s18  = sqrt(sum((who$thinness..1.19.years - mean(who$thinness..1.19.years))^2))
s19  = sqrt(sum((who$thinness.5.9.years - mean(who$thinness.5.9.years))^2))
s20  = sqrt(sum((who$Income.composition.of.resources -mean(who$Income.composition.of.resources))^2))
s21  = sqrt(sum((who$Schooling - mean(who$Schooling))^2))

z_Year<-(who$Year-mean(who$Year))/s_Year
#z_Status<-(Status-mean(Status))/s_Status
z_Adult.Mortality<-(who$Adult.Mortality-mean(who$Adult.Mortality))/s_Adult.Mortality
z_infant.deaths<-(who$infant.deaths-mean(who$infant.deaths))/s_infant.deaths
z_Alcohol<-(who$Alcohol-mean(who$Alcohol))/s_Alcohol
z_percentage.expenditure<-(who$percentage.expenditure-mean(who$percentage.expenditure))/s_percentage.expenditure
z_Hepatitis.B<-(who$Hepatitis.B-mean(who$Hepatitis.B))/s_Hepatitis.B
z_Measles<-(who$Measles-mean(who$Measles))/s_Measles
z_BMI<-(who$BMI-mean(who$BMI))/s_BMI
z_under.five.deaths<-(who$under.five.deaths-mean(who$under.five.deaths))/s_under.five.deaths
Life.expectancy_s<-(who$Life.expectancy-mean(who$Life.expectancy))/s_Life.expectancy

z12 = (who$Polio - mean(who$Polio))/s12
z13 = (who$Total.expenditure - mean(who$Total.expenditure))/s13
z14 = (who$Diphtheria - mean(who$Diphtheria))/s14
z15 = (who$HIV.AIDS - mean(who$HIV.AIDS))/s15
z16 = (who$GDP - mean(who$GDP))/s16
z17 = (who$Population - mean(who$Population))/s17
z18 = (who$thinness..1.19.years - mean(who$thinness..1.19.years))/s18
z19 = (who$thinness.5.9.years - mean(who$thinness.5.9.years))/s19
z20 = (who$Income.composition.of.resources - mean(who$Income.composition.of.resources))/s20
z21 = (who$Schooling - mean(who$Schooling))/s21

LifeSRModel<-lm(Life.expectancy_s~z_Year+z_Adult.Mortality+z_infant.deaths+z_Alcohol+z_percentage.expenditure+z_Hepatitis.B+z_Measles+z_BMI+z_under.five.deaths + z12 + z13 + z14 + z15 + z16 + z17 + z18 + z19 + z20 + z21 - 1  )

## variable selection ##
summary(LifeSRModel)
LifeSRModel$coefficients

```

After standardized and summary the model. We construct the hypothesis test:

hypothesis test
F test 
2.2e-16 < 0.05, reject H0, at least 1 predictor is useful. 

t test
for the predictors with p value > 0.05, we investigate them independently. 

Based on the hypothesis test, we conclude that z_percentage.expenditure , z_Hepatitis.B , z_Measles , Polio , GDP , Population , thinness..1.19.years and thinness.5.9.years has p-value larger than 0.05.

Thus, we will use these 8 predictor to fit the SLM with Life.expectancy_s to see if they have relationships.
```{r}
#Life.expectancy_s and percentage.expenditure
le <- lm( Life.expectancy_s ~ z_percentage.expenditure )
summary(le)
# Estimate Std. Error t value Pr(>|t|)    
#(Intercept)              1.794e-17  5.536e-04    0.00        1    
#z_percentage.expenditure 4.096e-01  2.248e-02   18.22   <2e-16 ***

#Life.expectancy_s and Hepatitis.B
lh <- lm( Life.expectancy_s ~ z_Hepatitis.B )
summary(lh)
# Estimate Std. Error t value Pr(>|t|)    
#(Intercept)   1.608e-17  5.945e-04   0.000        1    
#z_Hepatitis.B 1.999e-01  2.414e-02   8.281 2.49e-16 ***

#Life.expectancy_s and Measles
lmea <- lm( Life.expectancy_s ~ z_Measles )
summary(lmea)
#Estimate Std. Error t value Pr(>|t|)   
#(Intercept)  1.804e-17  6.054e-04   0.000  1.00000   
#z_Measles   -6.888e-02  2.458e-02  -2.802  0.00514 **

#Life.expectancy_s and Polio
lp <- lm( Life.expectancy_s ~ z12 )
summary(lp)
#Estimate Std. Error t value Pr(>|t|)    
#(Intercept) 1.998e-17  5.734e-04    0.00        1    
#z12         3.273e-01  2.328e-02   14.06   <2e-16 ***

#Life.expectancy_s and GDP
lg <- lm( Life.expectancy_s ~ z16 )
summary(lg)
#Estimate Std. Error t value Pr(>|t|)    
#(Intercept) 1.788e-17  5.445e-04    0.00        1    
#z16         4.413e-01  2.211e-02   19.96   <2e-16 ***

#Life.expectancy_s and Population
lpo <- lm( Life.expectancy_s ~ z17)
summary(lpo)
# Estimate Std. Error t value Pr(>|t|)
#(Intercept)  1.787e-17  6.066e-04   0.000    1.000
#z17         -2.230e-02  2.463e-02  -0.905    0.365

#Life.expectancy_s and thinness..1.19.years
lt1 <- lm( Life.expectancy_s ~ z18 )
summary(lt1)
# Estimate Std. Error t value Pr(>|t|)    
#(Intercept)  2.020e-17  5.395e-04     0.0        1    
#z18         -4.578e-01  2.191e-02   -20.9   <2e-16 ***

#Life.expectancy_s and thinness.5.9.years
lt5 <- lm( Life.expectancy_s ~ z19 )
summary(lt5)
# Estimate Std. Error t value Pr(>|t|)    
#(Intercept)  1.817e-17  5.396e-04    0.00        1    
#z19         -4.575e-01  2.191e-02  -20.88   <2e-16 ***

```

Conclusion:
Based on the model we fitted, the population has p value > 0.05 when fitting simple linear regression line with life expectancy,so coefficient of population is close to 0. Thus population is not strongly linearly related with life expectancy. We can remove population from the model then. 

Remove the population predictor from the model:
```{r}
#population remove from dataset 'who'
#with standardized data
LifeSRModel<-lm(Life.expectancy_s~z_Year+z_Adult.Mortality+z_infant.deaths+z_Alcohol+z_percentage.expenditure+z_Hepatitis.B+z_Measles+z_BMI+z_under.five.deaths + z12 + z13 + z14 + z15 + z16 + z18 + z19 + z20 + z21 - 1  )
summary(LifeSRModel)

#with original data
modelO <- lm(Life.expectancy~Year+Status+Adult.Mortality+infant.deaths+Alcohol+percentage.expenditure+Hepatitis.B+Measles+BMI+under.five.deaths + Polio + Total.expenditure + Diphtheria + HIV.AIDS + GDP + thinness..1.19.years + thinness.5.9.years + Income.composition.of.resources + Schooling, data = who)
summary(modelO)
```
After remove the population predictor from the model, we find out the model contain the population and the model without population, their estimate coefficient and R-squared does not have significant changes. Thus, we conclude that population does not affect the Life expectancy.


Here we use stepwise to select validate variable:
```{r}
##stepwise
#use stepwise method to complete variable selection
step(model, direction = 'both')

newmodel = lm(formula = Life.expectancy ~ Year + Status + Adult.Mortality + 
    infant.deaths + Alcohol + percentage.expenditure + BMI + 
    under.five.deaths + Total.expenditure + Diphtheria + HIV.AIDS + 
    thinness.5.9.years + Income.composition.of.resources + Schooling, 
    data = who)

summary(newmodel)
```

Then we do residual analysis on the new model generated. 
```{r}
## residual analysis ##

#Standardized Residuals vs. Index tut 4
plot( rstandard(newmodel))
#straight line around 0

n <- nrow( who )
plot( model$residuals[1:(n-1)] , model$residuals[2:n])
#straight line, linear relationship
```

```{r}
plot(newmodel)
```
constant variance (if not good, use transformation of y)
The first plot (Residuals vs fitted) has an approximately straight line at 0, while more data points appear on the right. Thus the model has generally met constant variance assumption. 

linearity (if not good, use transformation of x)
The second plot (Normal Q-Q plot) has an approximately straight line, thus the model generally met the linearity assumption. 

outlier
The observations 1880, 2306, 2300, 1901, 1902, 2503 are potential outliers. 
There's no point beyond cook's distance according to the leverage plot. 

```{r}
#leverage(cooks)
newmodel_influence <- influence(newmodel)
sort(newmodel_influence$hat, decreasing = TRUE)

#influence
newmodel_cook <- cooks.distance(newmodel)
sort(newmodel_cook, decreasing = TRUE)

```
We removed 6 predictors from the model, since those predictors are not acting important roles in our model fitting.
From the plot, we can see that there are 4 outliers. They are point 1880, point 2306 point 1901 and point 1902.


Our model contains 2 outliers, we will use robust regression to dampen the impact of highly influential observations and also violations in model assumptions.
Here we use Robust regression:
```{r}
#There is potential outlier, so we use robust
#robust
Rmodel = rlm(formula = Life.expectancy ~ Year + Status + Adult.Mortality + 
    infant.deaths + Alcohol + percentage.expenditure + BMI + 
    under.five.deaths + Total.expenditure + Diphtheria + HIV.AIDS + 
    thinness.5.9.years + Income.composition.of.resources + Schooling, 
    data = who, psi = psi.huber)

summary(Rmodel)

plot(Rmodel)
```
We want to investigate if there is a huge change in significance of regressors. 
percentage changed comparing with usual linear model fit:
(use difference between coefficient of usual model and Robust model to devide coefficient of usual model)
0.14, 0.40, 0.19, 0.05, 0.03, 0.12, 0.12, 0.04, 0.22, 0.05, 0.06, 0.08, 0.02, 0.07
the intercept has largest change, while the StatusDeveloping coefficient has a 40% decrease in magnitude of slope, which makes its significance decreases. Thus,the same variables do appear significant when compared to the usual linear model fit except for Status. 

After fitting the robust regression, the outlier 1880 is not in the plot anymore. Point 2306 , point 1901 and point 1902 are still potential outliers.


```{r}

##Bootstrap
## model validation ##
#cross validation

## confidence interval ##

## prediction interval ##



## predict a new point



plot(1:10)
plot(10:1)
```




##Conclusion











You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## Results

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))

## Conclusion